<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enviar Dinero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body { background-color: #f4f7f6; padding-top: 20px; } </style>
</head>
<body>

<div class="container" style="max-width: 600px;">
  <div class="card shadow border-0 rounded-4 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold mb-0">Enviar Dinero</h2>
      <a href="menu.html" class="btn-close"></a>
    </div>

    <!-- Sección de Contactos -->
    <div class="mb-3">
      <div class="d-flex gap-2 mb-3">
        <input type="text" class="form-control" placeholder="Buscar en agenda...">
        <button class="btn btn-primary" type="button">Buscar</button>
      </div>
      <button class="btn btn-outline-primary w-100 dashed-border mb-3" data-bs-toggle="modal" data-bs-target="#contactModal">
        + Agregar nuevo contacto
      </button>

      <label class="form-label text-muted">Seleccionar contacto reciente:</label>
      <select class="form-select mb-3" id="contactSelect">
        <option selected disabled>Elige un contacto...</option>
        <!-- Se llenará con JS -->
      </select>
    </div>

    <!-- Formulario de envío -->
    <form id="sendForm">
      <div class="mb-4">
        <label class="form-label fw-bold">Monto a transferir</label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input type="number" class="form-control" id="sendAmount" required min="1">
        </div>
        <small class="text-muted">Saldo disponible: <span id="displayBalance"></span></small>
      </div>
      <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Enviar Dinero</button>
    </form>
  </div>
</div>

<!-- MODAL: Agregar Contacto -->
<div class="modal fade" id="contactModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nuevo Contacto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newContactForm">
          <input type="text" class="form-control mb-2" id="cName" placeholder="Nombre y Apellido" required>
          <input type="text" class="form-control mb-2" id="cCBU" placeholder="Número de CBU" required>
          <input type="text" class="form-control mb-2" id="cAlias" placeholder="Alias" required>
          <input type="text" class="form-control mb-2" id="cBank" placeholder="Nombre del Banco" required>
          <button type="submit" class="btn btn-primary w-100 mt-3">Guardar Contacto</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const balance = parseFloat(localStorage.getItem('walletBalance')) || 0;
  document.getElementById('displayBalance').textContent = balance;

  // 1. Manejo de Contactos
  const contactForm = document.getElementById('newContactForm');
  const contactSelect = document.getElementById('contactSelect');

  // Cargar contactos guardados
  let contacts = JSON.parse(localStorage.getItem('walletContacts')) || [];
  function renderContacts() {
    contactSelect.innerHTML = '<option selected disabled>Elige un contacto...</option>';
    contacts.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.text = `${c.name} (${c.bank})`;
      contactSelect.appendChild(opt);
    });
  }
  renderContacts();

  // Guardar nuevo contacto
  contactForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const newContact = {
      name: document.getElementById('cName').value,
      cbu: document.getElementById('cCBU').value,
      alias: document.getElementById('cAlias').value,
      bank: document.getElementById('cBank').value
    };
    contacts.push(newContact);
    localStorage.setItem('walletContacts', JSON.stringify(contacts));

    // Cerrar modal y actualizar lista
    const modal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
    modal.hide();
    renderContacts();
    alert('Contacto agregado con éxito');
    contactForm.reset();
  });

  // 2. Manejo de Envío
  document.getElementById('sendForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const amount = parseFloat(document.getElementById('sendAmount').value);
    const receiver = contactSelect.value;

    if (contactSelect.selectedIndex === 0) {
      alert("Por favor selecciona un contacto.");
      return;
    }

    if (amount > balance) {
      alert("Fondos insuficientes.");
      return;
    }

    // Procesar transacción
    const newBalance = balance - amount;
    localStorage.setItem('walletBalance', newBalance);

    // Guardar historial
    let transactions = JSON.parse(localStorage.getItem('walletTransactions')) || [];
    transactions.unshift({
      type: 'payment',
      text: `Envío a ${receiver}`,
      amount: amount,
      date: new Date().toLocaleString()
    });
    localStorage.setItem('walletTransactions', JSON.stringify(transactions));

    alert(`Transferencia exitosa de $${amount} a ${receiver}.`);
    window.location.href = 'menu.html';
  });
</script>
</body>
</html>
